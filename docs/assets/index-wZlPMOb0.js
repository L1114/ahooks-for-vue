var ee=Object.defineProperty;var te=(t,e,r)=>e in t?ee(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var T=(t,e,r)=>(te(t,typeof e!="symbol"?e+"":e,r),r);import{h as re,i as U,j as O,k as j,l as ne,m as ie,n as C,w,g as L,p as k}from"./app-fEsgeMaf.js";import{c as $,a as q}from"./commonjsHelpers-1J56E-h6.js";class se{constructor(e,r,n,a){T(this,"count",0);T(this,"state",re({loading:!1,data:void 0,error:void 0,params:void 0}));T(this,"pluginImpls",[]);T(this,"lastFetchTime",0);T(this,"loadingDelayTimer");this.serviceRef=e,this.options=r,this.subscribe=n,this.initState=a,this.options=r||{};let i=r.defaultParams||[];this.state.params=Array.isArray(i)?i:[i]}setLoading(e){const r=Number(this.options.loadingDelay)||0;e?(clearTimeout(this.loadingDelayTimer),this.loadingDelayTimer=setTimeout(()=>{this.state.loading=!0},r)):(clearTimeout(this.loadingDelayTimer),this.state.loading=!1)}getRawParams(){return U(this.state.params)||[]}formatResult(e){let r=e;try{r=this.options.formatResult?this.options.formatResult(e):e}catch(n){console.log("error :>> ",n)}return r}userOptionsHook(e,...r){const n=this.options&&this.options[e];n&&n(...r)}pluginsLifecycleHook(e,...r){const n=this.pluginImpls.map(a=>{var i;return(i=a[e])==null?void 0:i.call(a,...r)}).filter(Boolean);return Object.assign({},...n)}run(...e){this.runAsync(...e).catch(r=>{this.options.onError||console.error(r)})}async runAsync(...e){this.count++;const r=this.count,{stopNow:n=!1,returnNow:a,data:i}=this.pluginsLifecycleHook("onBefore",e);if(n)return new Promise(()=>{});if(a)return Promise.resolve(i);try{this.state.params=e,this.userOptionsHook("onBefore",e),this.setLoading(!0),this.lastFetchTime=Date.now(),this.pluginsLifecycleHook("onRequest",e);const s=await this.serviceRef(...e);return r!==this.count?new Promise(()=>{}):(this.state.data=this.formatResult(s),this.state.error=void 0,this.setLoading(!1),this.userOptionsHook("onSuccess",s,e),this.userOptionsHook("onFinally",s,e),this.pluginsLifecycleHook("onSuccess",s,e),this.pluginsLifecycleHook("onFinally",s,e),s)}catch(s){if(r!==this.count)return new Promise(()=>{});throw this.setLoading(!1),this.state.error=s,this.userOptionsHook("onError",e,void 0,s),this.userOptionsHook("onFinally",e,void 0,s),this.pluginsLifecycleHook("onError",e,void 0,s),this.pluginsLifecycleHook("onFinally",e,void 0,s),s}}cancel(){this.count++,this.setLoading(!1),this.pluginsLifecycleHook("onCancel")}mutate(e){this.state.data=e}refresh(){this.run(...this.getRawParams())}refreshAsync(){return this.runAsync(...this.getRawParams())}}const ae=(t,e={},r=[])=>{const n=new se(t,e,()=>{},[]);return n.pluginImpls=r.map(a=>a(n,e)),{loading:O(n.state,"loading"),data:O(n.state,"data"),error:O(n.state,"error"),params:O(n.state,"params"),cancel:n.cancel.bind(n),refresh:n.refresh.bind(n),refreshAsync:n.refreshAsync.bind(n),run:n.run.bind(n),runAsync:n.runAsync.bind(n),mutate:n.mutate.bind(n)}};function oe(t){var e=typeof t;return t!=null&&(e=="object"||e=="function")}var p=oe,ue=typeof $=="object"&&$&&$.Object===Object&&$,le=ue,ce=le,fe=typeof self=="object"&&self&&self.Object===Object&&self,de=ce||fe||Function("return this")(),V=de,me=V,ge=function(){return me.Date.now()},ve=ge,he=/\s/;function be(t){for(var e=t.length;e--&&he.test(t.charAt(e)););return e}var ye=be,Te=ye,we=/^\s+/;function Ee(t){return t&&t.slice(0,Te(t)+1).replace(we,"")}var Se=Ee,je=V,Re=je.Symbol,X=Re,N=X,z=Object.prototype,Oe=z.hasOwnProperty,$e=z.toString,S=N?N.toStringTag:void 0;function Le(t){var e=Oe.call(t,S),r=t[S];try{t[S]=void 0;var n=!0}catch{}var a=$e.call(t);return n&&(e?t[S]=r:delete t[S]),a}var Pe=Le,ke=Object.prototype,Fe=ke.toString;function xe(t){return Fe.call(t)}var Ae=xe,I=X,Ce=Pe,pe=Ae,He="[object Null]",_e="[object Undefined]",B=I?I.toStringTag:void 0;function De(t){return t==null?t===void 0?_e:He:B&&B in Object(t)?Ce(t):pe(t)}var Ne=De;function Ie(t){return t!=null&&typeof t=="object"}var Be=Ie,We=Ne,Ge=Be,Me="[object Symbol]";function Ue(t){return typeof t=="symbol"||Ge(t)&&We(t)==Me}var qe=Ue,Ve=Se,W=p,Xe=qe,G=NaN,ze=/^[-+]0x[0-9a-f]+$/i,Je=/^0b[01]+$/i,Qe=/^0o[0-7]+$/i,Ye=parseInt;function Ze(t){if(typeof t=="number")return t;if(Xe(t))return G;if(W(t)){var e=typeof t.valueOf=="function"?t.valueOf():t;t=W(e)?e+"":e}if(typeof t!="string")return t===0?t:+t;t=Ve(t);var r=Je.test(t);return r||Qe.test(t)?Ye(t.slice(2),r?2:8):ze.test(t)?G:+t}var Ke=Ze,et=p,F=ve,M=Ke,tt="Expected a function",rt=Math.max,nt=Math.min;function it(t,e,r){var n,a,i,s,o,u,c=0,f=!1,l=!1,g=!0;if(typeof t!="function")throw new TypeError(tt);e=M(e)||0,et(r)&&(f=!!r.leading,l="maxWait"in r,i=l?rt(M(r.maxWait)||0,e):i,g="trailing"in r?!!r.trailing:g);function m(d){var h=n,E=a;return n=a=void 0,c=d,s=t.apply(E,h),s}function b(d){return c=d,o=setTimeout(R,e),f?m(d):s}function y(d){var h=d-u,E=d-c,D=e-h;return l?nt(D,i-E):D}function H(d){var h=d-u,E=d-c;return u===void 0||h>=e||h<0||l&&E>=i}function R(){var d=F();if(H(d))return _(d);o=setTimeout(R,y(d))}function _(d){return o=void 0,g&&n?m(d):(n=a=void 0,s)}function Z(){o!==void 0&&clearTimeout(o),c=0,n=u=a=o=void 0}function K(){return o===void 0?s:_(F())}function P(){var d=F(),h=H(d);if(n=arguments,a=this,u=d,h){if(o===void 0)return b(u);if(l)return clearTimeout(o),o=setTimeout(R,e),m(u)}return o===void 0&&(o=setTimeout(R,e)),s}return P.cancel=Z,P.flush=K,P}var J=it;const st=q(J);var at=J,ot=p,ut="Expected a function";function lt(t,e,r){var n=!0,a=!0;if(typeof t!="function")throw new TypeError(ut);return ot(r)&&(n="leading"in r?!!r.leading:n,a="trailing"in r?!!r.trailing:a),at(t,e,{leading:n,maxWait:e,trailing:a})}var ct=lt;const ft=q(ct),dt=(t,{throttleWait:e,throttleLeading:r,throttleTrailing:n})=>{const a={};if(r!==void 0&&(a.leading=r),n!==void 0&&(a.trailing=n),e!==void 0&&e>0){const i=t.runAsync.bind(t),s=ft(o=>{o()},e,a);t.runAsync=(...o)=>new Promise((u,c)=>{s(()=>{i==null||i(...o).then(f=>u(f)).catch(f=>c(f))})})}return{onCancel:()=>{}}},mt=(t,{debounceWait:e,debounceLeading:r,debounceTrailing:n,debounceMaxWait:a})=>{let i;const s={};if(r!==void 0&&(s.leading=r),n!==void 0&&(s.trailing=n),a!==void 0&&(s.maxWait=a),e!==void 0&&e>0){const o=t.runAsync.bind(t);i=st(u=>{u()},e,s),t.runAsync=(...u)=>new Promise((c,f)=>{i(()=>{o==null||o(...u).then(l=>c(l)).catch(l=>f(l))})})}return{onCancel:()=>{i==null||i.cancel()}}},gt=!!(typeof window<"u"&&window.document&&window.document.createElement),v=t=>j(t)?t.value:ne(t)?U(t):t,Q=(t,e)=>{if(!gt)return null;const r=e===void 0?window:e;let n=v(t);return typeof n=="function"&&(n=v(n())),n||r},vt=(t,{manual:e,ready:r=L(!0)})=>{let n=!1;ie(()=>{const i=v(r);n=!i,!e&&i&&t.refresh()}),C(()=>{t.cancel(),a()});const a=w(r,i=>{n=!v(r),!e&&i&&t.run(...t.getRawParams())});return{onBefore:()=>({stopNow:n})}},A=(t,e,r={})=>{const n=u=>e(u);let a=!1,i=Q(r==null?void 0:r.target);const s=u=>{u&&u(),o(),!(!(i!=null&&i.addEventListener)||a)&&i.addEventListener(t,n,{capture:r.capture,once:r.once,passive:r.passive})},o=u=>{u&&u(),i!=null&&i.removeEventListener&&i.removeEventListener(t,n,{capture:r.capture})};return s(),C(()=>{o()}),j(r==null?void 0:r.target)&&w(r==null?void 0:r.target,u=>{o(),i=u,s()}),{stop:()=>o(()=>a=!0),restart:()=>s(()=>a=!1)}},Y=t=>{const e=L("visible"),{stop:r,restart:n}=A("visibilitychange",()=>{e.value=document.visibilityState,t&&t(document.visibilityState)});return{documentVisibility:e,restart:n,stop:r}},ht=(t,{pollingInterval:e,pollingWhenHidden:r=!0,pollingErrorRetryCount:n=-1})=>{const a=k(()=>v(e)),i=k(()=>v(n)),s=k(()=>v(r));let o=!1,u=0,c;const f=m=>{m&&(o=m),clearTimeout(c)},l=t.run.bind(t);Y(m=>{if(!s.value){if(m==="visible"&&!o)return g(t.getRawParams());f()}}),t.run=(...m)=>{l(...m),g(m)};const g=m=>{if(f(),o=!1,!Number(a.value)||Number(a.value)<=0)return{};c=setTimeout(()=>{t.run(...m||[])},a.value)};return C(()=>f(!0)),{onError:()=>{u++,i.value!==void 0&&i.value!==-1&&u>=i.value&&f(!0)},onSuccess:()=>{u=0},onCancel(){f(!0)}}},bt=(t,e={})=>{const r=L(!1);let n=Q(t,null),a=()=>{},i=()=>{},s=()=>{a(),i()};const o=(e==null?void 0:e.focusin)||"focusin",u=(e==null?void 0:e.focusout)||"focusout",c=g=>A(o,m=>{var b,y;r.value||(r.value=!0,(b=e==null?void 0:e.onFocus)==null||b.call(e,m),(y=e==null?void 0:e.onChange)==null||y.call(e,!0))},{target:g}),f=g=>A(u,m=>{var b,y;r.value&&(r.value=!1,(b=e==null?void 0:e.onBlur)==null||b.call(e,m),(y=e==null?void 0:e.onChange)==null||y.call(e,!1))},{target:g});let l=()=>{s(),r.value=!1,a=c(n).stop,i=f(n).stop};return l(),w(t,g=>{s(),n=g,g&&l()}),{stop:()=>s(),restart:()=>l(),isFocusWithin:r}},yt=(t,{refreshOnWindowFocus:e,focusTimespan:r=5e3})=>{const n=()=>{Date.now()-t.lastFetchTime>v(r)&&t.refresh()};let a=()=>{},i=()=>{};const s=()=>{a(),i()};let o=()=>{s(),a=Y(u=>{u==="visible"&&n()}).stop,i=bt(()=>window,{onFocus:()=>{n()},focusin:"focus",focusout:"blur"}).stop};return v(e)&&o(),w([e,r].filter(u=>j(u)),([u])=>{u||u===void 0?o():s()}),{onCancel:()=>{s()}}},Tt=(t,{retryCount:e=0,retryInterval:r})=>{const n=L(0);let a=!1;const i=()=>{let l=v(r);return l=l>=0?l:Math.min(30*1e3,Math.pow(2,n.value+1)*1e3),l};let s=v(e),o=i();const u=()=>Number(s)>0||s===-1;let c=u(),f;return w([e,n].filter(l=>j(l)),()=>{s=v(e),c=u(),o=i(),c||clearTimeout(f)}),w([r].filter(l=>j(l)),()=>{n.value=0,o=i()}),{onRequest:()=>(a&&c&&(n.value++,console.log(`错误重试:第${n.value}次`)),clearTimeout(f),{}),onSuccess:()=>{n.value=0,a=!1},onError:()=>{a=!0,c&&(n.value<s||s===-1)&&(console.log("retryInterval :>> ",o),clearTimeout(f),f=setTimeout(()=>{t.refresh()},o))},onFinally:()=>{},onCancel:()=>{clearTimeout(f),c=!1}}};let x={};const wt=(t,{cacheKey:e,cacheTime:r=3e5,staleTime:n=0,setCache:a,getCache:i})=>({onBefore:()=>{if(!e)return{};if(typeof i=="function")return{data:i(),returnNow:!0};const{data:s,time:o}=x[e]||{},u=()=>r!==-1||!o?!1:Date.now()-o>r,c=()=>o?Date.now()-o>n:!0;return u()?x[e]=void 0:t.mutate(s),c()?{}:{data:s,returnNow:!0}},onSuccess:(s,o)=>{if(!(!e||!s)){if(typeof a=="function")return a(s);x[e]={time:Date.now(),params:o,data:s}}}}),Et=(t,e,r)=>ae(t,e,[...r||[],wt,dt,mt,ht,yt,Tt,vt]),Ot=Et;export{bt as a,Ot as b,A as m,Y as u};
